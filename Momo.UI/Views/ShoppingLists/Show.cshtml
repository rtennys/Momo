@using Momo.Common
@model ShoppingListsShowModel

@{
    var routeData = Request.RequestContext.RouteData;
    ViewBag.HeaderTitle = "{0}/{1}".F(routeData.Values["username"], routeData.Values["shoppinglist"]);
    ViewBag.Title = Model.Name;
}

@if (CurrentUser.HasShoppingListAccess())
{
    @Html.ActionLink("Add Item", "AddItem", null, new { data_role = "button", data_icon = "plus", data_mini = "true", data_inline = "true", data_ajax = "false" })

    using (Html.BeginForm("Clear", null, FormMethod.Post, new {data_ajax = "false", style = "display: inline;"}))
    {
        @Html.AntiForgeryToken()
        @Html.HiddenFor(m => m.Id)
        <input type="submit" value="Set all to Zero" data-icon="refresh" data-mini="true" data-inline="true" onclick=" return confirm('Setting a quantity to zero removes the item from view, but doesn\'t forget it.  Set all quantities to zero?'); " />
    }
    
    <div id="islePrompt" data-role="popup" class="ui-content">
        <a href="#" data-rel="back" data-role="button" data-theme="a" data-icon="delete" data-iconpos="notext" class="ui-btn-right">Close</a>
        @using (Html.BeginForm("UpdatePicked", null, null, FormMethod.Post, new {data_ajax = "false"}))
        {
            @Html.AntiForgeryToken()
            @Html.Hidden("Id")
            <div style="padding: 10px 20px;">
                <h3>Update Item?</h3>
                <ol>
                    <li>@Html.TextBox("Isle", null, new {autocomplete = "off"})</li>
                    <li>@Html.TextBox("Price", null, new {autocomplete = "off"})</li>
                </ol>
                <input type="submit" value="Save" />
            </div>
        }
    </div>

    // This is for the "picked" javascript
    @Html.AntiForgeryToken()
}

<ul data-role="listview" data-inset="true" data-split-icon="gear" data-split-theme="d">
    @if (Model.Items.Length == 0)
    {
        <li><em style="font-size: .85em;">No items in this list yet</em></li>
    }
    @foreach (var group in Model.Items.GroupBy(x => x.Isle))
    {
        <li data-role="list-divider">
            @(group.Key == 0 ? "Isle Not Set" : "Isle " + group.Key)
            <span class="ui-li-count">@group.Count()</span>
        </li>
        foreach (var item in group)
        {
            <li data-icon="false">
                <a href="#" style="padding: 0;">
                    <fieldset data-role="controlgroup" style="margin: 0;">
                        <input type="checkbox" data-shoppinglistitemid="@item.Id" data-shoppinglistitemisle="@item.Isle" data-shoppinglistitemprice="@item.Price" name="item-@item.Id" id="item-@item.Id" @(item.Picked ? "checked=\"checked\"" : "") @(CurrentUser.HasShoppingListAccess() ? "" : "disabled=\"disabled\"") />
                        <label for="item-@item.Id" style="font-size: .85em; border: 0;">@item.Name</label>
                    </fieldset>
                    <span class="ui-li-count" style="z-index: 1;">@item.Quantity</span>
                </a>
                @if (CurrentUser.HasShoppingListAccess())
                {
                    @Html.ActionLink("Edit", "EditItem", new { id = item.Id }, new { data_ajax = "false" })
                }
            </li>
        }
    }
</ul>

@if (CurrentUser.IsRouteUsername())
{
    <p>
        @Html.ActionLink("Rename", "Rename", null, new { data_role = "button", data_icon = "gear", data_mini = "true", data_inline = "true", data_ajax = "false" })
        @Html.ActionLink("Sharing", "Share", null, new { data_role = "button", data_icon = "gear", data_mini = "true", data_inline = "true", data_ajax = "false" })
    </p>
    <p>
        @using (Html.BeginForm("Delete", null, FormMethod.Post, new { data_ajax = "false", style = "display: inline;" }))
        {
            @Html.AntiForgeryToken()
            @Html.HiddenFor(m => m.Id)
            <input type="submit" value="Delete This List" data-icon="delete" data-mini="true" data-inline="true" onclick=" return confirm('Are you sure? All items and saved prices will be lost.'); " />
        }
    </p>
}

@section scripts
{
    <script type="text/javascript">
        $(function () {
            $(document).on('change', '[data-shoppinglistitemid]', function() {

                var cb = $(this),
                    data = {
                        id: cb.data('shoppinglistitemid'),
                        picked: cb.is(':checked')
                    };

                app.post('@Url.Action("ChangePicked")', data, function (result) {
                    if (!data.picked) return;

                    var isle = cb.data('shoppinglistitemisle'),
                        price = cb.data('shoppinglistitemprice');

                    $('#islePrompt form #Id').val(data.id);
                    $('#islePrompt form #Isle').val(isle == '0' ? '' : isle);
                    $('#islePrompt form #Price').val(price == '0.00' ? '' : price);

                    $('#islePrompt').popup('open');
                });

            });
        });
    </script>
}
